<div style="position: relative;"><a href="https://github.com/bonitasoft/bonita-doc/edit/7.5/md/single-sign-on-with-saml.md"><img style="position: absolute; top: -1px; right: -40px; border: 0; z-index=-100;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a></div>
<h1>Single sign-on with SAML</h1>
<div class="alert alert-info" role="alert">
<p><strong>Note:</strong> For Performance, Efficiency, and Teamwork editions only.</p>
</div>
<p>This pages explains how to configure your Bonita BPM Platform system to use the SAML protocol to provide single sign-on (SSO). It assumes you already have a SAML identity provider server up and running (IdP).</p>
<p>This information applies to a Bonita BPM platform deployed from a bundle (Tomcat or WildFly), not to the Engine launched from Bonita BPM Studio. <code>&lt;BUNDLE_HOME&gt;</code> refers to the root directory of the bundle.</p>
<p>SAML configuration is at tenant level. Each tenant can use a different authentication method (over SAML or not).</p>
<div class="alert alert-info" role="alert">
<p><strong>Note:</strong> Bonita BPM uses <a href="http://www.keycloak.org/" class="alert-link">Keycloak</a> as SAML service provider adapter.</p>
</div>
<h2>SAML overview for Bonita BPM</h2>
<p>This is an overview that relates the steps required to integrate a bonita BPM bundle with an SAML identity provider.</p>
<p><img src="bonita/images/7.5/saml-overview.png" alt="Authentication over SAML" class="img-responsive" title="Authentication over SAML"></p>
<p>Here some details about the Bonita SAML2 module,
it is composed of:</p>
<ul>
<li>
<p>A servlet filter that intercept all the requests to bonita portal pages</p>
<p>It checks if the user is already logged in on Bonita BPM</p>
<ul>
<li>If already logged in =&gt; Allow the access</li>
<li>If not logged in =&gt; Redirect to IdP (with user info)</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>One Assertion Consumer Service ACS URL (technically this is also handled by the servlet filter through a different URL mapping  <code>/saml</code>),</p>
<p>This service validates and process the SAML response :</p>
<ul>
<li>Decode SAMLResponse</li>
<li>Check if the answer is valid (certificate, date, origin)</li>
<li>Extract the username from it (NameId or subject attribute)</li>
<li>Connect to bonita using username</li>
<li>Redirect to the initial requested resource (relayState)</li>
</ul>
</li>
</ul>
<div class="alert alert-warning" role="alert">
<p>Bonita &quot;username&quot; should match the NameId or one attribute of the subject returned by the IdP in the response.
If some users need to be able to log in without having an account on the IDP, you can authorize it by activating an option in the file <code>authenticationManager-config.properties</code> (see 2. below). Users will then be able to log in using the portal login page (/login.jsp) provided they have a bonita account and their password is different from their username.</p>
</div>
<h2>Configure Bonita BPM Bundle for SAML</h2>
<p>You need to execute the following actions in the folder of each tenant for which you want to support authentication over SAML.
If you want this configuration to also apply to each tenant created later, make sure to also perform those actions in the <em>template</em> tenant configuration folder:
<code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/current/tenant_template_*</code> (if you have not started the Bonita bundle yet, the files are located in <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/initial/tenant_template_*</code>)</p>
<p>The bundle already contains the files needed to use SAML with Bonita BPM platform.<br>
To configure Bonita BPM for SAML:</p>
<ol>
<li>
<p>If you do not already have one:</p>
<ol>
<li>Download a Subscription edition bundle from the customer portal</li>
<li><a href="?page=_basic-bonita-bpm-platform-installation" ng-click="contentCtrl.goTo($event, '_basic-bonita-bpm-platform-installation')">Configure</a> it as needed</li>
<li>Run it a first time, so that the first default tenant is created (TENANT_ID = 1)</li>
<li>Stop it before modifying the configuration files below</li>
</ol>
</li>
<li>
<p>In the tenant_portal folder of each existing tenant: <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/current/tenants/&lt;TENANT_ID&gt;/tenant_portal</code>,
edit the authenticationManager-config.properties as follows:</p>
<pre><code>   --&gt;  #auth.AuthenticationManager = org.bonitasoft.console.common.server.auth.impl.standard.StandardAuthenticationManagerImpl
   --&gt;  auth.AuthenticationManager = org.bonitasoft.console.common.server.auth.impl.saml.SAML2AuthenticationManagerImpl
   --&gt;  saml.filter.active = true
   --&gt;  saml.auth.standard.allowed = false
   --&gt;  auth.tenant.admin.username = install
   --&gt;  auth.passphrase = BonitaBPM
        #auth.AuthenticationManager = org.bonitasoft.console.common.server.auth.impl.oauth.OAuthAuthenticationManagerImpl
        # OAuth.serviceProvider = LinkedIn
        # OAuth.consumerKey = ove2vcdjptar
        # OAuth.consumerSecret = vdaBrCmHvkgJoYz1
        # OAuth.callbackURL = http://127.0.0.1:8888/loginservice
        #auth.AuthenticationManager = org.bonitasoft.console.common.server.auth.impl.jaas.cas.CASRemoteAuthenticationManagerImpl
        # Cas.serverUrlPrefix = http://127.0.1.1:8180/cas
        # Cas.bonitaServiceURL = http://127.0.1.1:8080/bonita/loginservice
   --&gt;  logout.link.hidden=true 
</code></pre>
<p>Make sure to <a href="?hash=toc2&amp;page=multi-tenancy-and-tenant-configuration" ng-click="contentCtrl.goTo($event, 'multi-tenancy-and-tenant-configuration', 'toc2')">set the right tenant admin username</a>.
It is recommended to also replace the value of the passphrase (property auth.passphrase) which is used by the engine to verify the authentication request.
The value must be the same as in the file <strong>bonita-tenant-sp-custom.properties</strong>.<br>
If you need some users to be able to log in without having an account on the IDP, you can authorize it by setting the property <code>saml.auth.standard.allowed</code> to true. Users will then be able to log in using the portal login page (/login.jsp) provided they have a bonita account and their password is different from their username.</p>
</li>
<li>
<p>In the tenant_engine folder of each existing tenant: <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/current/tenants/&lt;TENANT_ID&gt;/tenant_engine/</code>,
edit the file <strong>bonita-tenant-sp-custom.xml</strong> to uncomment the bean passphraseOrPasswordAuthenticationService:</p>
<pre><code>     &lt;bean id=&quot;passphraseOrPasswordAuthenticationService&quot; class=&quot;com.bonitasoft.engine.authentication.impl.PassphraseOrPasswordAuthenticationService&quot; lazy-init=&quot;true&quot;&gt;
        &lt;constructor-arg name=&quot;logger&quot; ref=&quot;tenantTechnicalLoggerService&quot; /&gt;
        &lt;constructor-arg name=&quot;identityService&quot; ref=&quot;identityService&quot; /&gt;
        &lt;constructor-arg name=&quot;configuredPassphrase&quot; value=&quot;${authentication.service.ref.passphrase}&quot; /&gt;
    &lt;/bean&gt;
</code></pre>
</li>
<li>
<p>In the tenant_engine folder of each existing tenant: <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/current/tenants/&lt;TENANT_ID&gt;/tenant_engine/</code>
edit the file bonita-tenant-sp-custom.properties as follows:</p>
<pre><code>         # Authentication service to use. Some are natively provided:
         # authenticationService
         #   * binded to bonita authentication mode
         #   * impl: org.bonitasoft.engine.authentication.impl.AuthenticationServiceImpl
         # jaasAuthenticationService
         #   * to use JAAS
         #   * impl: com.bonitasoft.engine.authentication.impl.JAASGenericAuthenticationServiceImpl
         #   * this is the one to configure SSO over CAS (CAS properties to be defined hereafter
         # noAuthenticationService
         #   * does no authentication on the engine side
         #   * impl: com.bonitasoft.engine.authentication.impl.NoAuthenticationServiceImpl
         # passphraseOrPasswordAuthenticationService
         #   * Used by SAML2 implementation, login only if a passphrase is valid, or if a username/password is valid.
         #   * Requires PassphraseOrPasswordAuthenticationService bean to be uncommented in bonita-tenant-sp-custom.xml
         #   * impl: com.bonitasoft.engine.authentication.impl.PassphraseOrPasswordAuthenticationService
         # you can provide your own implementation in bonita-tenant-sp-custom.xml and refer to the bean name of your choice
    --&gt;  authentication.service.ref.name=passphraseOrPasswordAuthenticationService
         
         # If authentication.service.ref.name equals &quot;PassphraseOrPasswordAuthenticationService&quot;,
         # you need to configure the following passphrase 
    --&gt;  authentication.service.ref.passphrase=BonitaBPM
         
         # CAS authentication delegate : enables the user, providing login/password,
         # to be logged in automatically against CAS web application 
         # To be used in conjunction with the generic authentication service configured with CAS (jaasAuthenticationService)
         #authenticator.delegate=casAuthenticatorDelegate
         #authentication.delegate.cas.server.url.prefix=http://ip_address:port
         #authentication.delegate.cas.service.url=http://ip_address:port/bonita/loginservice
</code></pre>
<p>It is recommended to also replace the value of the passphrase (property auth.passphrase). The value must be the same as in the file <strong>authenticationManager-config.properties</strong> updated previously.</p>
</li>
<li>
<p>If your Identity provider (IdP) requires requests to be signed, generate a private key.
For example on linux, you can use the command ssh-keygen, then go to “cd ~/.ssh” to retrieve the key from the file id_rsa (more id_rsa, then copy the key).</p>
</li>
</ol>
<div class="alert alert-info" role="alert">
<p><strong>Note:</strong> The expected format for Keys and certificates is PEM (with or without the comment header and footer).</p>
</div>
<ol start="6">
<li>In the tenant_portal folder of each existing tenant: <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/current/tenants/&lt;TENANT_ID&gt;/tenant_portal</code>,<br>
edit the file <strong>keycloak-saml.xml</strong> to setup Bonita webapp as a Service provider working with your IdP.
<ul>
<li>
<p>The entityID is the Service Provider given to your bonita installation. You can change it if you want but you need to provide it to your IdP.</p>
</li>
<li>
<p>If your IdP requires the SSO requests to be signed replace the following strings in the Keys section of the SP:</p>
<ul>
<li>put your private key here</li>
<li>put your certificate here</li>
</ul>
<p>with you current server's private key and with the certificate provided by the IdP.<br>
If your IdP does not require the SSO requests to be signed, you can remove the Keys node from the SP and set the attribute signRequest to false.</p>
</li>
<li>
<p>If your IdP responses are signed, replace the following strings in the Keys section of the IDP:</p>
<ul>
<li>put your certificate here</li>
</ul>
<p>with the certificate provided by the IdP (same certificate as in the SP section).<br>
If your IdP responses are not signed, you can remove the Keys node from the IDP and set the attribute validateResponseSignature to false.</p>
</li>
<li>
<p>The PrincipalNameMapping policy indicates how to retrieve the subject attribute that matches a bonita user account username from the IdP response.
The policy can either be FROM_NAME_ID or FROM_ATTRIBUTE (in that case you need to specify the name of the subject attribute to use).</p>
</li>
<li>
<p>You may also need to change the requestBinding and/or responseBinding from POST to REDIRECT depending on your IdP configuration.</p>
</li>
<li>
<p>The url binding to your IdP also needs to be define by replacing the following string:</p>
<ul>
<li>http://idp.saml.binding.url.to.change</li>
</ul>
</li>
</ul>
</li>
</ol>
<div class="alert alert-warning" role="alert">
<p><strong>Note 1:</strong> If both the requests to the IdP and the responses are signed, this means you need to add the certificate twice: in the SP section as well as in the IDP section.</p>
</div>
<div class="alert alert-info" role="alert">
<p><strong>Note 2:</strong> More configuration options can be found in <a href="https://keycloak.gitbooks.io/documentation/securing_apps/topics/saml/java/general-config.html" class="alert-link">Keycloak official documentation</a></p>
</div>
<pre><code>    &lt;keycloak-saml-adapter&gt;
        &lt;SP entityID=&quot;bonita&quot;
            sslPolicy=&quot;EXTERNAL&quot;
            logoutPage=&quot;http://localhost:8080/bonita/logoutservice&quot;
            forceAuthentication=&quot;false&quot;
            isPassive=&quot;false&quot;
            turnOffChangeSessionIdOnLogin=&quot;true&quot;&gt;
            &lt;Keys&gt;
                &lt;Key signing=&quot;true&quot;&gt;
     --&gt;            &lt;PrivateKeyPem&gt;put your private key here&lt;/PrivateKeyPem&gt;
     --&gt;            &lt;CertificatePem&gt;put your certificate here&lt;/CertificatePem&gt;
                &lt;/Key&gt;
            &lt;/Keys&gt;
            &lt;PrincipalNameMapping policy=&quot;FROM_ATTRIBUTE&quot; attribute=&quot;username&quot;/&gt;
            &lt;IDP entityID=&quot;idp&quot;&gt;
                &lt;SingleSignOnService signRequest=&quot;true&quot;
                   validateResponseSignature=&quot;true&quot;
                   requestBinding=&quot;POST&quot;
                   responseBinding=&quot;POST&quot;
     --&gt;           bindingUrl=&quot;http://idp.saml.binding.url.to.change&quot;/&gt;
                &lt;SingleLogoutService signRequest=&quot;false&quot;
                   signResponse=&quot;false&quot;
                   validateRequestSignature=&quot;false&quot;
                   validateResponseSignature=&quot;false&quot;
                   requestBinding=&quot;POST&quot;
                   responseBinding=&quot;POST&quot;
                   postBindingUrl=&quot;http://idp.saml.binding.url.to.change&quot;
                   redirectBindingUrl=&quot;http://idp.saml.binding.url.to.change&quot;/&gt;
                &lt;Keys&gt;
                    &lt;Key signing=&quot;true&quot;&gt;
     --&gt;            &lt;CertificatePem&gt;put your certificate here&lt;/CertificatePem&gt;
                    &lt;/Key&gt;
                &lt;/Keys&gt;
            &lt;/IDP&gt;
         &lt;/SP&gt;
    &lt;/keycloak-saml-adapter&gt;
</code></pre>
<ol start="7">
<li>If your Identity Provider is corectly configured (see the section <em>Configure the Identity provider</em>), you are done.<br>
Then you can try to access a portal page, an app page or a form URL (or just <code>http://&lt;host&gt;:&lt;port&gt;/bonita[?tenant=&lt;tenantId&gt;]</code>) and make sure that you are redirected to your Identity Provider to log in (unless you are already logged in).<br>
Note that if you try to access <code>http://&lt;bundle host&gt;:&lt;port&gt;/bonita/login.jsp</code>, then you won't be redirected as this page still needs to be accessible in order for the tenant administrator (or another user if you set the property <code>saml.auth.standard.allowed</code> to true) to be able to log in without an account on the Identity Provider.</li>
</ol>
<div class="alert alert-info" role="alert">
<p><strong>Note 1:</strong> The single logout SAML profile is not supported by bonita as it doesn't work the same way for each IdP.<br>
So the SingleLogoutService configuration is not used (but the element still needs to be present in order for the filter to work...).</p>
</div>
<div class="alert alert-warning" role="alert">
<p><strong>Note 2:</strong> If your Bonita BPM platform is behind a proxy server, You need to make sure the reverse proxy is configured
to include the correct <code>Host:</code> header to the requests and the application server is configured to use this header (it is usually the case by default).
This is required so that <code>HttpServletRequest.getRequestURL</code> returns the URL used by the user and not the internal URL used by the reverse proxy.<br>
For example, if you are running Apache &gt;=2.0.31 as reverse proxy, this configuration is controlled by the property <a href="http://httpd.apache.org/docs/2.2/mod/mod_proxy.html#proxypreservehost" class="alert-link">ProxyPreserveHost</a>.
If you need more fine tuning or if you cannot update the reverse proxy configuration, you can consult the official documentation for <a href="https://tomcat.apache.org/connectors-doc/common_howto/proxy.html" class="alert-link">Tomcat</a> or <a href="https://docs.jboss.org/author/display/WFLY10/Undertow+subsystem+configuration" class="alert-link">WildFly</a>.</p>
</div>
<h2>Configure the Identity provider</h2>
<p>Your IdP should declare a Service Provider named <code>bonita</code> (or the value of the <code>entityID</code> set in the file <strong>keycloack-saml.xml</strong> of Bonita BPM bundle if it is different) with the following configuration:</p>
<ul>
<li>ACS URL or SAML Processing URL: <code>http[s]://&lt;bundle host&gt;:&lt;port&gt;/bonita/saml</code></li>
<li>request binding and response binding configured with the same values as in <strong>keycloack-saml.xml</strong> (<code>POST</code> or <code>REDIRECT</code>)</li>
<li><code>Client signature required</code> configured with the same values as the property <code>signRequest</code> in <strong>keycloack-saml.xml</strong></li>
<li>if the IdP responses are signed, make sure the certificate of the IdP has been set in <strong>keycloack-saml.xml</strong></li>
<li>the Name ID or a user attribute of the user principal sent back by the IdP should match the username of the user accounts in Bonita BPM and the PrincipalNameMapping policy (and attribute value) in <strong>keycloack-saml.xml</strong> should reflect that</li>
</ul>
<div class="alert alert-info" role="alert">
<p><strong>Note:</strong> If the IdP declares a redirect/target URL, it might override the target URL set by the service provider request, and you may always end up on the same page after logging in. In that case, try to remove the redirect URL. Bonita BPM supports redirection to the URL initially requested after logging in on the IdP provided the IdP doesn't force this URL.</p>
</div>
<h2>Troubleshoot</h2>
<p>To troubleshoot SSO login issues, you need to add a logging handler for the package <code>org.keycloak</code> and increase the <a href="?page=logging" ng-click="contentCtrl.goTo($event, 'logging')">log level</a> to <code>ALL</code> for the packages <code>org.bonitasoft</code>, <code>com.bonitasoft</code>, and <code>org.keycloak</code> in order for errors to be displayed in the log files bonita-*.log (by default, they are not).</p>
<p>In order to do that in a Tomcat bundle, you need to edit the file `&lt;BUNDLE_HOME&gt;/server/conf/logging.properties.</p>
<ul>
<li>Add the lines:</li>
</ul>
<pre><code>org.keycloak.handlers = 5bonita.org.apache.juli.FileHandler
org.keycloak.level = ALL
</code></pre>
<ul>
<li>Update the existing lines (to set the level to <code>ALL</code>):</li>
</ul>
<pre><code>org.bonitasoft.level = ALL
com.bonitasoft.level = ALL
</code></pre>
<p>In a WildFly bundle, you need to edit the file <code>&lt;BUNDLE_HOME&gt;/server/standalone/configuration/standalone.xml</code> in the domain <code>urn:jboss:domain:logging:3.0</code> of the <em>subsystem</em> tag.</p>
<p>Edit the <em>logger</em> tags which <em>category</em> matches <code>org.bonitasoft</code> and <code>com.bonitasoft</code> packages: change the <em>level</em> <em>name</em> attribute of each <em>logger</em> to <code>ALL</code> and add a new logger with the <em>category</em> <code>org.keyclock</code> (also with a <em>level</em> <em>name</em> set to <code>ALL</code>).</p>
<h2>Configure logout behaviour</h2>
<h4>Bonita BPM Portal</h4>
<p>When your Bonita BPM platform is configured to manage authentication over SAML, when users log out of Bonita BPM Portal, they do not log out of the SAML Identity Provider (IdP).<br>
Therefore they are not logged out of all applications that are using the IdP.<br>
To avoid this, you can hide the logout option of the portal.<br>
To do this, set the <code>logout.link.hidden=true</code> option in <code>authenticationManager-config.properties</code> located in <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/initial/tenant_template_portal</code>
for not initialized platform or <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/current/tenant_template_portal</code> and <code>&lt;BUNDLE_HOME&gt;/setup/platform_conf/current/tenants/&lt;TENANT_ID&gt;/tenant_portal/</code>.</p>
<div class="alert alert-info" role="alert">
<p><strong>Note:</strong> When a user logs out from the IdP, Bonita Portal's session will remain active. The user's session time to live will be reset
to the configured session timeout value upon each user interaction with the server.</p>
</div>
<h2>Manage passwords</h2>
<p>When your Bonita BPM platform is configured to manage authentication over SAML, the user password are managed in your SAML Identity provider (IdP).<br>
However, when you create a user in Bonita BPM Portal, specifying a password is mandatory. This password is ignored.</p>
<h2>LDAP synchronizer and SAML</h2>
<p>If you are using an LDAP service and the <a href="?page=ldap-synchronizer" ng-click="contentCtrl.goTo($event, 'ldap-synchronizer')">LDAP synchronizer</a> to manage your user data,<br>
you can continue to do this and manage authentication over SAML.<br>
The LDAP synchronizer user must be registered in Bonita BPM (no need for an SAML IdP account). It is recommended though to use the tenant admin account.<br>
We recommend that you use LDAP as your master source for information, synchronizing the relevant information with your Bonita BPM platform.</p>
<div class="alert alert-info" role="alert">
<p><strong>Note :</strong> By default the <a href="?page=ldap-synchronizer" ng-click="contentCtrl.goTo($event, 'ldap-synchronizer')" class="alert-link">LDAP synchronizer</a> sets the password of the accounts created with the same value as the username. So, even if you allow standard authentication (by setting the property <code>saml.auth.standard.allowed</code> in <strong>authenticationManager-config.properties</strong>), users won't be able to log in with the portal login page directly without going through the IdP.</p>
</div>
<h2>Single sign-on with SAML using the REST API</h2>
<p>SAML is a browser-oriented protocol (based on http automatic redirection, forms, etc...), therefore only resources that require a direct access from a web browser are handled by the SAML filter.
Access to other resources won't trigger an SAML authentication process.
Here is the subset of pages filtered by the SAML filter:</p>
<ul>
<li>/saml</li>
<li>/samlLogout</li>
<li>/portal/homepage</li>
<li>/portal/resource/*</li>
<li>/portal/form/*</li>
<li>/mobile/*</li>
<li>/apps/*</li>
</ul>
<p>REST API are not part of them, but if an http session already exists thanks to cookies, REST API can be used.</p>
<p>The recommended way to authenticate to Bonita BPM Portal to use the REST API is to use the <a href="?hash=bonita-authentication&amp;page=rest-api-overview" ng-click="contentCtrl.goTo($event, 'rest-api-overview', 'bonita-authentication')">login service</a>..</p>
<!-- Generated on Wed Jan 31 2018 10:20:49 GMT+0100 (Paris, Madrid) -->