<div style="position: relative;"><img style="position: absolute; top: -1px; right: -40px; border: 0; z-index=-100;" src="bonita/images/7.3/outOfSupport.png" alt="Out of support"></div>
<h1>How to map authorization rules</h1>
<h2>Introduction</h2>
<p>This tutorial explains how to customize authorization rule mapping.</p>
<p>Authorization rule is a java bean that must implement <code>getId</code> and <code>isAllowed</code> methods.</p>
<p>Authorization Rule Mapping is a set of rules used to allow connected user to access <a href="?page=page-and-form-development-overview" ng-click="contentCtrl.goTo($event, 'page-and-form-development-overview')">page and form</a>. An empty list grants access to user. A non empty list allows access if all rules return true to their <code>isAllowed</code> method. Those rules grant or not access to the connected user for:</p>
<ul>
<li>use a page or form to start a process</li>
<li>display process overview</li>
<li>use a page or form to execute a task</li>
</ul>
<p>The tutorial can be used with Bonita BPM Community edition, and uses features that are available in all editions.</p>
<div class="alert alert-warning" role="alert">
<p>The following elements may be used as extension points but could be subject to change across versions. No changes are planned, but we reserve the right to change make incompatible changes in any future version.</p>
</div>
<h2>Create and deploy custom authorization rule</h2>
<h3>Create custom authorization rule java project</h3>
<p>In this example, Custom authorization rule is a maven-based java project that need a <code>maven</code> dependency on <code>bonita-server</code> maven artifact.</p>
<ul>
<li><code>pom.xml</code></li>
</ul>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.bonitasoft.example&lt;/groupId&gt;
    &lt;artifactId&gt;authorization-tutorial&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.bonitasoft.engine&lt;/groupId&gt;
            &lt;artifactId&gt;bonita-server&lt;/artifactId&gt;
            &lt;version&gt;${bonita-server.version}&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
    &lt;properties&gt;
        &lt;bonita-server.version&gt;[7.3.0,)&lt;/bonita-server.version&gt;
    &lt;/properties&gt;
    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
                &lt;version&gt;3.5.1&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;source&gt;1.7&lt;/source&gt;
                    &lt;target&gt;1.7&lt;/target&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
&lt;/project&gt;
</code></pre>
<ul>
<li>create CustomRule class that implements <code>org.bonitasoft.engine.page.AuthorizationRule</code></li>
</ul>
<pre><code class="language-java">package org.bonitasoft.example.authorization;

import java.io.Serializable;
import java.util.Map;

import org.bonitasoft.engine.commons.exceptions.SExecutionException;
import org.bonitasoft.engine.core.process.instance.api.ProcessInstanceService;
import org.bonitasoft.engine.page.AuthorizationRule;
import org.bonitasoft.engine.page.AuthorizationRuleWithParameters;
import org.bonitasoft.engine.session.SessionService;
import org.bonitasoft.engine.sessionaccessor.SessionAccessor;

public class CustomRule extends AuthorizationRuleWithParameters implements AuthorizationRule {

    private ProcessInstanceService processInstanceService;

    private SessionService sessionService;

    private SessionAccessor sessionAccessor;

    public CustomRule(ProcessInstanceService processInstanceService, SessionService sessionService, SessionAccessor sessionAccessor) {
        // some services autowired by spring
        this.processInstanceService = processInstanceService;
        this.sessionAccessor = sessionAccessor;
        this.sessionService = sessionService;
    }

    @Override
    public boolean isAllowed(String key, Map&lt;String, Serializable&gt; context) throws SExecutionException {
        //add business logic here
        return true;
    }

    @Override
    public String getId() {
        return &quot;CUSTOM_RULE_UNIQUE_ID&quot;;
    }
}

</code></pre>
<ul>
<li>create CustomAuthorizationRuleMapping class that implements <code>org.bonitasoft.engine.core.form.AuthorizationRuleMapping</code></li>
</ul>
<pre><code class="language-java">package org.bonitasoft.example.authorization;

import java.util.Arrays;
import java.util.List;

import org.bonitasoft.engine.core.form.AuthorizationRuleMapping;

public class CustomAuthorizationRuleMapping implements AuthorizationRuleMapping {

    @Override
    public List&lt;String&gt; getProcessStartRuleKeys() {
        return Arrays.asList(&quot;CUSTOM_RULE_UNIQUE_ID&quot;);
    }

    @Override
    public List&lt;String&gt; getProcessOverviewRuleKeys() {
        return Arrays.asList(&quot;CUSTOM_RULE_UNIQUE_ID&quot;);
    }

    @Override
    public List&lt;String&gt; getTaskRuleKeys() {
        return Arrays.asList(&quot;CUSTOM_RULE_UNIQUE_ID&quot;);
    }
}

</code></pre>
<ul>
<li>build maven jar</li>
</ul>
<pre><code>mvn clean install
</code></pre>
<h3>Configure engine with new rules</h3>
<ul>
<li>
<p>copy jar into <code>webapps/bonita/WEB-INF/lib/</code> folder (for default tomcat bundle)</p>
</li>
<li>
<p>pull current engine configuration using platform setup tool</p>
</li>
</ul>
<pre><code> ./setup/setup.sh pull  
</code></pre>
<ul>
<li>add customRule bean registration in <code>platform_conf/current/tenants/TENANT_ID/tenant_engine/bonita-tenant-custom.xml</code></li>
</ul>
<pre><code class="language-xml"> &lt;bean id=&quot;customRule&quot; class=&quot;org.bonitasoft.example.authorization.CustomRule&quot;&gt;
    &lt;constructor-arg name=&quot;processInstanceService&quot; ref=&quot;processInstanceService&quot; /&gt;
    &lt;constructor-arg name=&quot;sessionService&quot; ref=&quot;sessionService&quot; /&gt;
    &lt;constructor-arg name=&quot;sessionAccessor&quot; ref=&quot;sessionAccessor&quot; /&gt;
 &lt;/bean&gt;         
 
</code></pre>
<ul>
<li>add customAuthorizationRuleMapping bean registration in <code>platform_conf/current/tenants/TENANT_ID/tenant_engine/bonita-tenant-custom.xml</code></li>
</ul>
<pre><code class="language-xml"> &lt;bean id=&quot;customAuthorizationRuleMapping&quot;
          class=&quot;org.bonitasoft.example.authorization.CustomAuthorizationRuleMapping&quot;/&gt;
</code></pre>
<ul>
<li>uncomment to declare customAuthorizationRuleMapping in <code>platform_conf/current/tenants/TENANT_ID/tenant_engine/bonita-tenant-community-custom.properties</code></li>
</ul>
<pre><code>bonita.tenant.authorization.rule.mapping=customAuthorizationRuleMapping
</code></pre>
<ul>
<li>push current engine configuration using platform setup tool</li>
</ul>
<pre><code> ./setup/setup.sh push  
</code></pre>
<ul>
<li>restart server</li>
</ul>
<pre><code>./bonita-stop.sh
./bonita-start.sh
</code></pre>
<div class="alert alert-info" role="alert">
<p>You can find a complete implementation example of page mapping authorization rule and configuration in <a href="https://github.com/bonitasoft/bonita-page-authorization-rules" class="alert-link">this project on GitHub</a>.</p>
</div>
<!-- Generated on Tue Jun 19 2018 09:27:07 GMT+0200 (Paris, Madrid (heure d’été)) -->