<div style="position: relative;"><img style="position: absolute; top: -1px; right: -40px; border: 0; z-index=-100;" src="bonita/images/7.3/outOfSupport.png" alt="Out of support"></div>
<h1>Install a Bonita BPM cluster</h1>
<div class="alert alert-info" role="alert">
<p><strong>Note:</strong> The cluster feature is a Subscription feature for <strong>Performance</strong> edition only.</p>
</div>
<div class="alert alert-warning" role="alert">
<p>It is possible to manage the lifecycle of a node using the API to connect directly to the node, but this bypasses the load balancer so should be done with care and only in exceptional circumstances.</p>
</div>
<p>You will learn here how to create a cluster in two ways:</p>
<ul>
<li>Create a cluster from scratch</li>
<li>Convert a single node installation into a cluster</li>
</ul>
<h2>Note when using the AWS support</h2>
<p>Please read the following to ensure that Bonita Cluster works correctly on AWS.</p>
<h3>Add a jar to the Bonita war</h3>
<p>To proceed</p>
<ul>
<li>download the <a href="http://repo1.maven.org/maven2/com/hazelcast/hazelcast-cloud/3.4.1/">hazelcast-cloud-3.4.1.jar</a></li>
<li>ensure that Bonita is stopped</li>
<li>add the jar to the bonita war and the bonita folder (the jar must be stored in the <code>WEB-INF/lib</code> subfolder of these 2
elements)</li>
<li>the hazelcast aws support will be fully available at next Bonita startup</li>
</ul>
<h2>Create a cluster from scratch</h2>
<p>In this part we will create a cluster from scratch. We will initialize the database on which the cluster will run, then we will configure nodes to run on this cluster.</p>
<h3><a id="create_init_bonita_db" /> Create and initialize the database for Bonita BPM Platform</h3>
<p>In this step you will create and initialize the database for the Bonita BPM Platform cluster using the <a href="?page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup')">platform setup tool</a>.
When done you will have a database with all tables created and with a table <code>CONFIGURATION</code> containing all configuration required for the cluster to start.</p>
<ul>
<li>Ensure that you meet the <a href="?page=hardware-and-software-requirements" ng-click="contentCtrl.goTo($event, 'hardware-and-software-requirements')">requirements</a></li>
<li>Ensure that you <a href="?hash=database_creation&amp;page=database-configuration" ng-click="contentCtrl.goTo($event, 'database-configuration', 'database_creation')">have a database installed and configured for the platform</a>.</li>
<li>In case you use <a href="?page=define-and-deploy-the-bdm" ng-click="contentCtrl.goTo($event, 'define-and-deploy-the-bdm')">Business data</a>, ensure that you <a href="?page=database-configuration-for-business-data" ng-click="contentCtrl.goTo($event, 'database-configuration-for-business-data')">have a database installed and configured for the Business Data</a>.</li>
<li>Download the Bonita BPM <a href="?page=deploy-bundle" ng-click="contentCtrl.goTo($event, 'deploy-bundle')">Deploy bundle</a> and unzip it at some place of your choice.</li>
</ul>
<div class="alert alert-info" role="alert">
<p>The platform setup tool is also present in the Tomcat or JBoss bundle under the <code>setup</code> directory.</p>
</div>
<ul>
<li>Configure it as described in the <a href="?hash=configure_tool&amp;page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup', 'configure_tool')">platform setup tool page</a></li>
<li>Update configuration files that are in the <code>platform_conf/initial</code> folder of the platform setup tool.
<ul>
<li>In <code>platform_init_engine/bonita-platform-init-community-custom.properties</code> uncomment and update the value of <code>activeProfiles</code> property from <strong><code>community</code></strong> to <strong><code>community,performance</code></strong>.</li>
<li>In <code>platform_engine/bonita-platform-sp-custom.properties</code>
<ul>
<li>uncomment and set the <strong><code>bonita.cluster</code></strong> property to <code>true</code>.</li>
<li><a id="disable-hibernate-cache"/>In order to keep consistency between nodes, the Hibernate cache must be disabled.<br>
Uncomment and change the line<br>
<code>#bonita.platform.persistence.use_second_level_cache=true</code><br>
to<br>
<code>bonita.platform.persistence.use_second_level_cache=false</code></li>
</ul>
</li>
<li>In <code>platform_engine/bonita-platform-sp-cluster-custom.properties</code>
<ul>
<li>uncomment and set the <strong><code>bonita.cluster.name</code></strong> property to a name of your own, e.g. <code>myBPMCluster</code>, <strong>This name must be unique on the local network if you are using <em>multicast</em></strong></li>
<li>set one of <code>bonita.platform.cluster.hazelcast.multicast.enabled</code>, <code>bonita.platform.cluster.hazelcast.tcpip.enabled</code> and <code>bonita.platform.cluster.hazelcast.aws.enabled</code> to <code>true</code>.
Uncomment the # properties and set only one of them to <code>true</code>, set the others to <code>false</code> depending on how you want your nodes to discover each others. If you don't use <code>bonita.platform.cluster.hazelcast.multicast.enabled</code>, you <strong>must</strong> uncomment the # properties and set it to <code>false</code>.
For more information on this take a look at the <a href="http://docs.hazelcast.org/docs/3.4/manual/html-single/hazelcast-documentation.html#hazelcast-cluster-discovery">Hazelcast Documentation</a>.</li>
</ul>
</li>
</ul>
</li>
<li>Copy licenses of all your nodes in <code>platform_conf/licenses</code></li>
<li>run the <code>setup.sh init</code> or <code>setup.bat init</code> as described in the <a href="?hash=init_platform_conf&amp;page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup', 'init_platform_conf')">platform setup tool page</a>.</li>
<li>At the end of the script, you should see the following line: &quot;Initial configuration files successfully pushed to database&quot;</li>
<li>This creates the database tables needed by Bonita BPM platform, stores the configuration into this database, and stores the licence files for all your cluster nodes
into the database.</li>
</ul>
<p>If later you need to change the configuration of the node discovery or add new licenses to the Bonita BPM Platform configuration, you can update the configuration by following this <a href="?hash=update_platform_conf&amp;page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup', 'update_platform_conf')">guide</a>.</p>
<h3><a id="install_first_node" /> Install a first node</h3>
<ol>
<li>
<p>Follow the instructions to <a href="?page=tomcat-bundle" ng-click="contentCtrl.goTo($event, 'tomcat-bundle')">configure a Tomcat bundle</a>.
You can skip the part on creating and initializing the database but you will need to configure the bundle connection to the database as described <a href="?hash=datasources_configuration&amp;page=tomcat-bundle" ng-click="contentCtrl.goTo($event, 'tomcat-bundle', 'datasources_configuration')">in this part</a>.</p>
</li>
<li>
<p>Delete the entire content of the <code>[TOMCAT_DIRECTORY]/setup</code> folder.</p>
</li>
<li>
<p>If your Bonita installation is behind a proxy or is installed inside a Docker container (mainly in TcpIp or Aws
discovery modes), you must declare its public address by adding the following property :
<code>-Dhazelcast.local.publicAddress=*publicaddress*</code>, this property should be added in the <code>[TOMCAT_DIRECTORY]/bin/setenv.sh</code> or <code>[TOMCAT_DIRECTORY]/bin/setenv.bat</code></p>
</li>
<li>
<p>When the installation is complete, start Tomcat on the node. This starts Bonita BPM Platform:</p>
</li>
</ol>
<pre><code class="language-bash">./bonita-start.sh
</code></pre>
<ol start="5">
<li>Then start the cluster in the load balancer.</li>
</ol>
<p>Check that the log file contains messages of the following form:</p>
<pre><code>March 22, 2016 5:07:07 PM com.hazelcast.cluster.ClusterService
INFO: [10.0.5.2]:5701 [myBPMCluster]

Members [1] {
        Member [10.0.5.2]:5701 this
}
[...]
March 22, 2016 5:09:18 PM org.apache.catalina.startup.Catalina start
INFO: Server startup in 30333 ms
</code></pre>
<p>Then deploy a basic process and check that it runs correctly, to validate the installation.</p>
<h3>Add a node to the cluster</h3>
<p>You can add a new node to a cluster without interrupting service on the existing nodes.</p>
<ol>
<li>Install another Tomcat the same way you just installed the first node.</li>
<li>Configure the new node to access the same database.</li>
<li>If Hazelcast Node discovery is configured with TCP, update the configuration in database using the <a href="?page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup')">platform setup tool page</a>.</li>
<li>Start the Tomcat on the new node, running <code>./bonita-start.sh</code> script</li>
<li>Update the load balancer configuration to include the new node.</li>
</ol>
<p>The log file will contain messages of the following form:</p>
<pre><code>March 22, 2016 5:12:53 PM com.hazelcast.cluster.ClusterService
INFO: [10.0.5.2]:5701 [bonita]

Members [2] {
        Member [10.0.5.2]:5701 this
        Member [10.0.5.3]:5701
}
[...]
March 22, 2016 5:12:28 PM org.apache.coyote.http11.Http11Protocol start
INFO: Starting Coyote HTTP/1.1 on http-7280
March 22, 2016 5:12:28 PM org.apache.catalina.startup.Catalina start
INFO: Server startup in 30333 ms
</code></pre>
<p>In the log, you can see how many nodes are in the cluster, and their IP addresses and port number. This node that has been started is indicated by <code>this</code>.
The new node is now available to perform work as directed by the load balancer.</p>
<h2>Convert a single node installation into a cluster</h2>
<p>In this case you already have a Bonita BPM Platform running as single node installation, you will change the configuration to make it able to have multiple nodes.</p>
<h3>Update the configuration in database</h3>
<p>Some properties of the Bonita BPM Platform needs to be changed in order to make the cluster work.</p>
<ul>
<li>Download the Bonita BPM <a href="?page=deploy-bundle" ng-click="contentCtrl.goTo($event, 'deploy-bundle')">Deploy bundle</a> and unzip it at some place of your choice.</li>
</ul>
<div class="alert alert-info" role="alert">
<p>The platform setup tool is also present in the Tomcat or JBoss bundle under the <code>setup</code> directory.</p>
</div>
<ul>
<li>Configure it as described in the <a href="?page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup')">platform setup tool page</a></li>
<li>Run the <code>setup.sh pull</code> or <code>setup.bat pull</code>. This will retrieve the configuration of your platform under <code>platform_conf/current</code> folder.</li>
<li>Update configuration files that are in the <code>platform_conf/initial</code> folder of the platform setup tool.
<ul>
<li>In <code>platform_init_engine/bonita-platform-init-community-custom.properties</code> as described in <a href="?hash=create_init_bonita_db&amp;page=" ng-click="contentCtrl.goTo($event, '', 'create_init_bonita_db')">Create and initialize database</a>.</li>
<li>In <code>platform_engine/bonita-platform-sp-custom.properties</code> as described in <a href="?hash=create_init_bonita_db&amp;page=" ng-click="contentCtrl.goTo($event, '', 'create_init_bonita_db')">Create and initialize database</a>.</li>
</ul>
</li>
</ul>
<div class="alert alert-info" role="alert">
<ul>
<li><strong>The 3 steps below are required when Bonita BPM version is <code>7.3.1</code> or lower, otherwise this step is managed by migration tool. Change quartz scheduler name in database:</strong>
<ul>
<li>disable foreign keys on tables <code>qrtz_cron_triggers</code>, <code>qrtz_simple_triggers</code>, <code>qrtz_simprop_triggers</code> and <code>qrtz_triggers</code></li>
<li>execute following SQL update:</li>
</ul>
<pre><code class="language-sql">UPDATE QRTZ_LOCKS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_CRON_TRIGGERS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_SIMPLE_TRIGGERS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_JOB_DETAILS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_FIRED_TRIGGERS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_TRIGGERS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_SCHEDULER_STATE SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_SIMPROP_TRIGGERS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_CALENDARS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_BLOB_TRIGGERS SET SCHED_NAME = 'BonitaClusteredScheduler';
UPDATE QRTZ_PAUSED_TRIGGER_GRPS SET SCHED_NAME = 'BonitaClusteredScheduler';
</code></pre>
<ul>
<li>enable foreign keys on tables <code>qrtz_cron_triggers</code>, <code>qrtz_simple_triggers</code>, <code>qrtz_simprop_triggers</code> and <code>qrtz_triggers</code></li>
</ul>
</li>
</ul>
</div>
<ul>
<li>Copy licenses of all your nodes in <code>platform_conf/licenses</code></li>
<li>Run the <code>setup.sh push</code> or <code>setup.bat push</code>. This will update in database the configuration of your platform.</li>
</ul>
<h3>Configure nodes to run on this cluster</h3>
<p>The configuration of the node you were using is still valid. You should be able to run it without any issue.</p>
<p>If your Bonita installation is behind a proxy or is installed inside a Docker container, please refer to the
<a href="?hash=install_first_node&amp;page=" ng-click="contentCtrl.goTo($event, '', 'install_first_node')">Install a first node part</a>.</p>
<h2>Cluster management</h2>
<h3>Stop a node</h3>
<p>Simply run <code>./bonita-stop.sh</code> script.</p>
<h3>Remove a node from a cluster</h3>
<p>This section explains how to perform a planned shutdown and remove a node from the cluster.</p>
<ol>
<li>Update the load balancer configuration so that no further work is directed to the node. All work that is already in progress on the node that will be shutdown
will continue until completion. Do not remove the node completely, because the load balancer needs to be informed when current work is finished.</li>
<li>Allow current activity instances to complete.</li>
<li>Stop the Tomcat server: run <code>./bonita-stop.sh</code></li>
<li>Update the load balancer to remove the node from the cluster.</li>
</ol>
<p>The node is now removed from the cluster.</p>
<h3>Dismantle a cluster</h3>
<p>To dismantle a cluster:</p>
<ol>
<li>Disable processes.</li>
<li>Allow current activity instances to complete.</li>
<li>When each node has finished executing, stop it.</li>
<li>When all nodes have been stopped, update the load balancer to remove the cluster.</li>
</ol>
<p>The individual nodes can now be used as standalone Bonita BPM server, provided the following change in the configuration is done:
Update file <code>bonita-platform-sp-custom.properties</code> located in the <code>platform_engine</code> folder of the configuration, use the <a href="?hash=configuration_files&amp;page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup', 'configuration_files')">platform setup tool</a> to update it and set back the <strong><code>bonita.cluster</code></strong> property to <strong><code>false</code></strong>.</p>
<p>See <a href="?hash=updating_configuration&amp;page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup', 'updating_configuration')">How to update a Bonita BPM Tomcat Bundle configuration</a> for more details on updating the configuration.</p>
<h3>Managing the cluster with Hazelcast</h3>
<p>A Bonita BPM cluster uses Hazelcast as the distributed cluster dispatcher layer. Therefore you can use the Hazelcast tools to manage the cluster topology.
See the <a href="http://www.hazelcast.com/docs.jsp">Hazelcast documentation</a> for details.</p>
<p>Note that a Bonita BPM cluster uses multicast for discovery by default. You can disable this in Hazelcast.
If you are using multicast, you must ensure that your production environment is insulated from any test environment that might also contain cluster nodes.
This is to ensure the nodes do not discover each other on the network, if they are not supposed to run inside the same cluster.</p>
<p>It is possible to have more than one cluster on the same network. In this case, you must configure the cluster names to be sure that it is clear which node belongs to which cluster.
You can configure the cluster name through Hazelcast or by updating <code>bonita-platform-sp-custom.properties</code> located in the <code>platform_engine</code> folder of the configuration, use the <a href="?hash=configuration_files&amp;page=BonitaBPM_platform_setup" ng-click="contentCtrl.goTo($event, 'BonitaBPM_platform_setup', 'configuration_files')">platform setup tool</a> to update it.</p>
<h2>FAQ</h2>
<p><strong>Q</strong>: I regularly get this warning message when 2 or more nodes are started in cluster:</p>
<pre><code class="language-log">2016-06-13 11:41:22.783 +0200 WARNING: org.bonitasoft.engine.scheduler.impl.BonitaJobStoreCMT This scheduler instance (...) is still active but was recovered by another instance in the cluster.  This may cause inconsistent behavior.
</code></pre>
<p><strong>Symptom</strong>:
The clocks of the servers are not synchronized.</p>
<p><strong>Resolution</strong>:
The system time of all cluster nodes must be maintained in synchronization with time servers.
It is a good idea to have also the db server system time synchronized too.
Synchronize the system time of all nodes and restart application servers.</p>
<!-- Generated on Tue Jun 19 2018 09:27:07 GMT+0200 (Paris, Madrid (heure d’été)) -->